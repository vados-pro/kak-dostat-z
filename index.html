<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Как достать Z — Highlight Motor Group (Phaser 3)</title>
<style>
  :root{--bg:#0f1117;--ink:#eef2ff;--mut:#a7b3c7;--acc:#34d399;--warn:#ffd166;--bad:#ff6b6b}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  #ui{position:fixed;inset:auto 0 0 0;display:flex;flex-direction:column;align-items:center;gap:8px;padding:8px 10px}
  .hud{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .chip{background:#151b26;border:1px solid #0005;border-radius:14px;padding:6px 10px;font-size:13px;color:#d6dde8}
  .chip b{color:#fff}
  .topbar{position:fixed;left:0;right:0;top:6px;display:flex;gap:10px;justify-content:center;align-items:center}
  .btn{appearance:none;border:1px solid #0005;background:#1c2330;color:#e9f0ff;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  .btn.acc{background:var(--acc);color:#05150e}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#1a202b;border:1px solid #0005}
  #vol{accent-color:#34d399}
  #log{height:18px;font-size:13px;color:#cfd7e3;text-align:center}
  #game{display:block;margin:60px auto 100px;border:2px solid #000;box-shadow:0 18px 64px #000c}
</style>
</head>
<body>
<div class="topbar">
  <button class="btn acc" id="playBtn">Играть</button>
  <button class="btn" id="howBtn">Правила</button>
  <span class="pill">Громкость <input id="vol" type="range" min="0" max="1" step="0.01" value="0.45"></span>
  <span class="pill">Рекорды: <span id="best">—</span></span>
</div>
<canvas id="game" width="1280" height="720"></canvas>
<div id="ui">
  <div id="log"></div>
  <div class="hud">
    <div class="chip">Уровень: <b id="lvl">—</b></div>
    <div class="chip">Задачи: <b id="goals">0/0</b></div>
    <div class="chip">Инвентарь: <b id="inv">—</b></div>
    <div class="chip">Стелс: <b id="stealth">—</b></div>
    <div class="chip">Время: <b id="time">0:00</b></div>
    <div class="chip">Пойман: <b id="caught">0</b></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>
<script>
const UI={lvl:byId('lvl'),goals:byId('goals'),inv:byId('inv'),stealth:byId('stealth'),time:byId('time'),caught:byId('caught'),log:byId('log'),best:byId('best')};
byId('howBtn').onclick=()=>alert('Сайд‑вью как в «Как достать соседа»: подбирай предметы, пакости на станциях и уходи к зелёной зоне. Прячься и не попадайся Z.');
function byId(id){return document.getElementById(id)}
function fmt(ms){const s=Math.floor(ms/1000),m=(s/60|0);return `${m}:${String(s%60).padStart(2,'0')}`;}
const LS='kdz_phaser_records_v1'; function loadBest(){try{return JSON.parse(localStorage.getItem(LS)||'{}')}catch{return{}}}
function saveBest(name,t,c){const r=loadBest(),o=r[name];const better=!o||t<o.t||(t===o.t&&c<o.c);if(better){r[name]={t,c,at:Date.now()};localStorage.setItem(LS,JSON.stringify(r));}UI.best.textContent=bestStr();}
function bestStr(){const r=loadBest(),k=Object.keys(r);return k.length?k.map(n=>`${n}: ${fmt(r[n].t)}, пойман ${r[n].c}`).join(' • '):'—';}
UI.best.textContent=bestStr();

const W=1280,H=720;
const game=new Phaser.Game({
  type:Phaser.CANVAS, canvas:document.getElementById('game'),
  width:W, height:H, backgroundColor:'#0c1017', pixelArt:true,
  physics:{default:'arcade', arcade:{gravity:{y:700}, debug:false}},
  scene:{preload,create,update}
});

let S={}, started=false, paused=false, finished=false;

function makePattern(scene,key,svg,w=64,h=64){
  const img='data:image/svg+xml;base64,'+btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">${svg}</svg>`);
  scene.textures.addBase64(key,img);
}
function makeSheet(scene,key,svg,w,h){
  const img='data:image/svg+xml;base64,'+btoa(svg);
  scene.textures.addBase64(key,img);
}
function preload(){
  makePattern(this,'carpet',`
    <defs><linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0" stop-color="#e6eefb"/><stop offset="1" stop-color="#dde7f6"/></linearGradient></defs>
    <rect width="64" height="64" fill="url(#g)"/>
    <path d="M0 16h64M0 32h64M0 48h64" stroke="#c7d2e3" stroke-width="1" opacity=".55"/>
    <path d="M8 8l2 3m12 6l2 3m22 10l2 3m-18 8l2 3" stroke="#c0ccdd" stroke-linecap="round" opacity=".5"/>
  `);
  makePattern(this,'tiles',`
    <rect width="64" height="64" fill="#f2f2f2"/>
    <path d="M0 0h64v64H0zM32 0v64M0 32h64" stroke="#e2e2e2"/>
  `);
  makePattern(this,'wood',`
    <rect width="64" height="64" fill="#b78351"/>
    <path d="M0 21h64M0 43h64" stroke="#8b5a33" opacity=".6"/>
    <path d="M6 10c10 6 22 6 32 0M8 32c12 6 24 6 34 0" stroke="#754726" opacity=".4" fill="none"/>
    <circle cx="18" cy="14" r="2" fill="#7c4b28" opacity=".7"/>
    <circle cx="42" cy="38" r="2" fill="#7c4b28" opacity=".7"/>
  `);
  makePattern(this,'wallpaper',`
    <rect width="64" height="64" fill="#edf2fb"/>
    <path d="M8 0v64M24 0v64M40 0v64M56 0v64" stroke="#d6e0f0" stroke-width="3" opacity=".8"/>
  `);
  makePattern(this,'concrete',`
    <rect width="64" height="64" fill="#eef2f7"/>
    <circle cx="14" cy="12" r="1" fill="#cdd5e1"/><circle cx="34" cy="22" r="1" fill="#cdd5e1"/>
    <circle cx="52" cy="40" r="1" fill="#cdd5e1"/><circle cx="22" cy="50" r="1" fill="#cdd5e1"/>
  `);
  makeSheet(this,'sprPlayer', spriteSheet('#ffe3bd','#2d6cdf','#0b1020'), 256,32);
  makeSheet(this,'sprBoss',   spriteSheet('#ffd2d2','#e45b5b','#0b1020'), 256,32);
  this.load.image('hl_logo','header-logo.png');
}
function spriteSheet(skin,suit,outline){
  const W=256,H=32,FW=32;
  let frames='';
  for(let i=0;i<8;i++){
    const phase=(i%4<2?1:-1)*(i%2?5:0);
    frames+=`
    <g transform="translate(${i*FW},0)">
      <rect x="8" y="11" rx="6" ry="6" width="16" height="18" fill="${suit}" stroke="${outline}" stroke-width="1"/>
      <circle cx="16" cy="8" r="7" fill="${skin}" stroke="${outline}" stroke-width="1"/>
      <circle cx="13" cy="8" r="1.6" fill="#111"/><circle cx="19" cy="8" r="1.6" fill="#111"/>
      <rect x="10" y="${20+phase/2}" width="5" height="10" rx="2.5" fill="${outline}" opacity=".7"/>
      <rect x="17" y="${18-phase/2}" width="5" height="10" rx="2.5" fill="${outline}" opacity=".7"/>
    </g>`;
  }
  const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">${frames}</svg>`;
  return svg;
}

function create(){
  const scene=this; S.scene=scene;
  const vol = parseFloat(document.getElementById('vol').value||'0.45');
  scene.sound.volume = vol;
  document.getElementById('vol').addEventListener('input', e=> scene.sound.volume=parseFloat(e.target.value));

  const g=scene.add.graphics(); g.fillGradientStyle(0x1a2233,0x1a2233,0x0c1017,0x0c1017,1); g.fillRect(0,0,1280,720);

  const rooms = [
    { x:60,  y:420, w:360, h:220, floor:'carpet',  wall:'wallpaper', label:'Приёмная' },
    { x:460, y:420, w:360, h:220, floor:'tiles',   wall:'concrete',  label:'Переговорка' },
    { x:860, y:420, w:360, h:220, floor:'wood',    wall:'wallpaper', label:'Кабинет Z' }
  ];
  S.rooms=rooms;

  rooms.forEach(r=>{
    scene.add.tileSprite(r.x,r.y,r.w,r.h,r.wall).setOrigin(0,0);
    scene.add.tileSprite(r.x, r.y+r.h-64, r.w, 64, r.floor).setOrigin(0,0);
    scene.add.rectangle(r.x+r.w/2, r.y+r.h-5, r.w, 10, 0x000000, 0.15).setDepth(1);
    scene.add.text(r.x+10, r.y+10, r.label, {font:'16px Arial', color:'#1b2538'}).setDepth(2);
  });

  drawReception(scene, rooms[0]);
  drawMeeting(scene, rooms[1]);
  drawBossOffice(scene, rooms[2]);

  S.doors = [
    scene.add.rectangle(420, 530, 20, 140, 0xaeb8c7).setOrigin(0.5,0.5),
    scene.add.rectangle(820, 530, 20, 140, 0xaeb8c7).setOrigin(0.5,0.5)
  ];

  S.hides = [
    scene.add.rectangle(321, 576, 82,36, 0xb8f8c6).setStrokeStyle(1,0x1c6a32),
    scene.add.rectangle(566, 576, 92,36, 0xb8f8c6).setStrokeStyle(1,0x1c6a32),
    scene.add.rectangle(1046,576, 92,36, 0xb8f8c6).setStrokeStyle(1,0x1c6a32)
  ];

  S.exit = scene.add.rectangle(120,582, 80,44, 0x88ff88).setStrokeStyle(1,0x007700);

  S.items = [
    mkItem(scene, 220,568,'Жвачка'),
    mkItem(scene, 560,568,'Скрепка'),
    mkItem(scene, 340,568,'Соль')
  ];

  S.stations = [
    mkStation(scene, 980,560,120,32,'Жвачка','Микрофон Z'),
    mkStation(scene, 620,560,120,32,'Скрепка','Проектор'),
    mkStation(scene,1040,560,100,32,'Соль','Кофе Z')
  ];

  scene.anims.create({key:'pWalk', frames:scene.anims.generateFrameNumbers('sprPlayer',{start:0,end:7}), frameRate:10, repeat:-1});
  const p = scene.add.sprite(100, 620, 'sprPlayer',0).setOrigin(0.5,1);
  scene.physics.add.existing(p); p.body.setCollideWorldBounds(true);
  S.player = p; S.pDir = 1; S.pHidden = false; S.pRoom=0;

  S.floors = rooms.map(r=>{
    const y=r.y+r.h-10;
    const line=scene.add.rectangle(r.x+r.w/2, y, r.w, 10, 0x000000,0).setOrigin(0.5,0);
    scene.physics.add.existing(line,true);
    return line;
  });
  S.floors.forEach(f=>scene.physics.add.collider(p,f));

  scene.anims.create({key:'bWalk', frames:scene.anims.generateFrameNumbers('sprBoss',{start:0,end:7}), frameRate:10, repeat:-1});
  const b = scene.add.sprite(980, 620, 'sprBoss',0).setOrigin(0.5,1);
  scene.physics.add.existing(b); b.body.setAllowGravity(false);
  b.play('bWalk');
  S.boss=b; S.bdir=-1; S.bpath=[940,1180]; S.bsee=0;

  S.vision = scene.add.graphics({x:0,y:0}).setDepth(10).setAlpha(0.85);

  if (this.textures.exists('hl_logo')) {
    const plate = scene.add.rectangle(1075, 390, 330+20, 80+20, 0x0b0f15, 0.92).setDepth(4);
    plate.setStrokeStyle(2,0x34d399,0.6);
    scene.add.image(1075, 390, 'hl_logo').setDisplaySize(330,80).setDepth(5);
  }

  S.keys = scene.input.keyboard.addKeys('LEFT,RIGHT,UP,DOWN,A,D,W,S,E,SPACE,ESC,R');

  S.name='Офис Highlight — Миссия 1'; S.catches=0; S.time=0;
  updateHUD();
  byId('playBtn').onclick=()=>startGame();
  startGame();
}

function updateHUD(){
  UI.lvl.textContent=S.name;
  const done=S.stations.filter(s=>s.getData('done')).length; UI.goals.textContent=`${done}/${S.stations.length}`;
  UI.inv.textContent=(S.inv&&S.inv.length)? S.inv.join(', ') : '—';
  UI.stealth.textContent=S.pHidden?'в укрытии':'на виду';
  UI.time.textContent=fmt(S.time);
  UI.caught.textContent=S.catches||0;
}
function setLog(t){ UI.log.textContent=t||''; }

function drawReception(sc,r){
  drawDesk(sc,r.x+120,r.y+r.h-86, 180,56, 0xb37a46);
  drawCooler(sc,r.x+50, r.y+r.h-120);
  drawPlant(sc,r.x+r.w-50, r.y+r.h-110);
}
function drawMeeting(sc,r){
  drawTable(sc,r.x+100, r.y+r.h-90, 180,50);
  drawChair(sc,r.x+120, r.y+r.h-90); drawChair(sc,r.x+220, r.y+r.h-90);
  drawScreen(sc,r.x+40, r.y+40, 280,80);
}
function drawBossOffice(sc,r){
  drawDesk(sc,r.x+930- r.x, r.y+r.h-88, 170,54, 0x9a6c3f);
  drawLaptop(sc,r.x+980, r.y+r.h-110);
  drawCoffee(sc,r.x+1040, r.y+r.h-98);
  drawCabinet(sc,r.x+880, r.y+r.h-140, 80,110);
}
function softShadow(sc,x,y,w,h){ sc.add.ellipse(x+w/2,y+h, w/2,8, 0x000000,0.18).setDepth(2);}
function drawDesk(sc,x,y,w,h,col){ softShadow(sc,x,y,w,h); sc.add.rectangle(x+w/2,y+h/2,w,h,col).setDepth(3);
  sc.add.rectangle(x+w/2,y+4,w,8,0x7a4b2a).setDepth(3); sc.add.rectangle(x+w/2,y+h/2,w-16,h-16,0x7a4b2a).setDepth(3);
  sc.add.rectangle(x+w/2,y+h/2-4,w-20,h-22,col).setDepth(3);
}
function drawTable(sc,x,y,w,h){ softShadow(sc,x,y,w,h); sc.add.rectangle(x+w/2,y+h/2,w,h,0xc49b6b).setDepth(3);
  sc.add.rectangle(x+w/2,y+h-6,w-20,8,0x8a5b35).setDepth(3);
}
function drawChair(sc,x,y){ softShadow(sc,x-12,y-10,24,24); sc.add.rectangle(x, y-22, 24,8, 0x3b82f6).setOrigin(0.5,0.5).setDepth(3);
  sc.add.rectangle(x, y-10, 20,10, 0x3b82f6).setDepth(3);
  sc.add.rectangle(x-6, y, 6,12, 0x1e40af).setDepth(3); sc.add.rectangle(x+6, y, 6,12, 0x1e40af).setDepth(3);}
function drawCooler(sc,x,y){ softShadow(sc,x-10,y-6,28,60); sc.add.rectangle(x+4,y-25,28,50,0xcfe5ff).setOrigin(0.5,0.5).setDepth(3);
  sc.add.circle(x+4,y-48,8,0x8ab6e9).setDepth(3);}
function drawPlant(sc,x,y){ softShadow(sc,x-16,y-6,32,40); for(let i=0;i<6;i++){ sc.add.ellipse(x+(i%2?8:-8),y-16-i*6,12,6,0x2e7d32,1).setDepth(3);} sc.add.rectangle(x,y-6,24,12,0x8d6e63).setDepth(3); }
function drawScreen(sc,x,y,w,h){ sc.add.rectangle(x+w/2,y+h/2,w,h,0x111111).setDepth(3);
  sc.add.rectangle(x+w/2,y+10,w,h*0.4,0xffffff,0.06).setDepth(3); }
function drawLaptop(sc,x,y){ softShadow(sc,x-12,y+10,36,18); sc.add.rectangle(x+6,y+7,36,22,0xcfd7e2).setDepth(3);
  sc.add.rectangle(x+6,y+5,32,12,0x9fb0c6).setDepth(3); }
function drawCoffee(sc,x,y){ sc.add.circle(x,y,8,0x8e5a3c).setDepth(3); sc.add.rectangle(x,y,12,4,0xffffff).setDepth(3); }
function drawCabinet(sc,x,y,w,h){ softShadow(sc,x,y,w,h); sc.add.rectangle(x+w/2,y+h/2,w,h,0xb78351).setDepth(3);
  sc.add.rectangle(x+w/2,y+h/2,w-12,h-12,0x7a4b2a).setDepth(3); }

function mkItem(sc,x,y,name){
  const z=sc.add.zone(x,y,22,22).setOrigin(0,0); sc.physics.add.existing(z,false); z.body.setAllowGravity(false);
  z.setData('type','item'); z.setData('name',name);
  const g=sc.add.graphics(); g.fillStyle(0xffffff,1); g.fillCircle(x+11,y+11,14);
  let icon=sc.add.graphics(); if(name==='Жвачка'){icon.fillStyle(0xff5fa2,1);icon.fillRect(x+3,y+5,16,12);icon.fillStyle(0xffffff,1);icon.fillRect(x+5,y+9,12,4);}
  if(name==='Скрепка'){icon.lineStyle(3,0x2ecc71,1);icon.beginPath();icon.arc(x+10,y+11,8,0,Math.PI*1.5);icon.stroke();}
  if(name==='Соль'){icon.fillStyle(0xbdc3c7,1);icon.fillRect(x+4,y,14,20);icon.fillStyle(0xecf0f1,1);icon.fillRect(x+6,y+4,10,8);}
  return z;
}
function mkStation(sc,x,y,w,h,need,label){
  const box=sc.add.rectangle(x+w/2,y+h/2,w,h,0xffd166).setStrokeStyle(1,0x111111);
  const txt=sc.add.text(x+6,y-6,label,{font:'13px Arial',color:'#111'}); const z=sc.add.zone(x,y,w,h).setOrigin(0,0); sc.physics.add.existing(z,false); z.body.setAllowGravity(false);
  z.setData('type','station'); z.setData('need',need); z.setData('label',label); z.setData('done',false);
  z.setData('box',box); z.setData('txt',txt); return z;
}

function update(time,delta){
  if(!started||paused||finished) return;
  S.time += delta; UI.time.textContent = fmt(S.time);
  const p=S.player, k=S.keys;
  let vx = (k.A.isDown||k.LEFT.isDown?-160:0) + (k.D.isDown||k.RIGHT.isDown?160:0);
  p.body.setVelocityX(vx);
  if(vx!==0){ p.anims.play('pWalk',true); p.setFlipX(vx<0); S.pDir = vx<0?-1:1; } else { p.anims.stop(); p.setFrame(0); }
  const onDoor = S.doors.some(d => Math.abs(p.x-d.x)<18 && Math.abs(p.y-(d.y+50))<48);
  if((k.W.isDown||k.UP.isDown) && onDoor){ shiftRoom(1); }
  if((k.S.isDown||k.DOWN.isDown) && onDoor){ shiftRoom(-1); }
  if(Phaser.Input.Keyboard.JustDown(k.E)) interact();
  if(Phaser.Input.Keyboard.JustDown(k.SPACE)) toggleHide();
  bossPatrol(delta);
  if(Phaser.Input.Keyboard.JustDown(k.ESC)) paused=!paused;
  if(Phaser.Input.Keyboard.JustDown(k.R)) restart();
}

function shiftRoom(dir){
  const rooms=S.rooms; let idx=S.pRoom+dir; if(idx<0||idx>=rooms.length) return;
  const cur=rooms[S.pRoom], next=rooms[idx]; const off=(S.player.x-cur.x)/cur.w;
  S.pRoom=idx; S.player.x = next.x + off*next.w; setLog('Перешёл в: '+next.label);
}
function interact(){
  for(const it of S.items){
    if(Phaser.Geom.Intersects.RectangleToRectangle(S.player.getBounds(), it.getBounds())){
      S.inv=S.inv||[]; S.inv.push(it.getData('name')); it.disableBody(true,true); setLog('Взял: '+it.getData('name')); updateHUD(); return;
    }
  }
  for(const st of S.stations){
    if(st.getData('done')) continue;
    if(Phaser.Geom.Intersects.RectangleToRectangle(S.player.getBounds(), st.getBounds())){
      const need=st.getData('need'); const idx=(S.inv||[]).indexOf(need);
      if(idx>=0){ S.inv.splice(idx,1); st.setData('done',true); st.getData('box').setFillStyle(0xcfd7e2); st.getData('txt').setText(st.getData('label')+' ✓'); setLog('Пакость: '+st.getData('label')); updateHUD(); }
      else setLog('Нужно: '+need);
      checkWin();
      return;
    }
  }
}
function toggleHide(){
  const inHide=S.hides.some(h=>Phaser.Geom.Intersects.RectangleToRectangle(S.player.getBounds(), h.getBounds()));
  if(inHide){ S.pHidden=!S.pHidden; UI.stealth.textContent=S.pHidden?'в укрытии':'на виду'; setLog(S.pHidden?'Спрятался':'Вышел из укрытия'); }
}
function checkWin(){
  const allDone = S.stations.every(s=>s.getData('done'));
  const atExit = Phaser.Geom.Intersects.RectangleToRectangle(S.player.getBounds(), S.exit.getBounds());
  if(allDone && atExit){ finished=true; saveBest(S.name,S.time,S.catches||0); setLog('Победа 🎉'); }
}
function restart(){
  S.player.setPosition(100,620); S.pRoom=0; S.inv=[]; S.pHidden=false; S.catches=0; S.time=0;
  S.stations.forEach(s=>{ s.setData('done',false); s.getData('box').setFillStyle(0xffd166); s.getData('txt').setText(s.getData('label')); });
  S.items.forEach(it=>it.enableBody(false,it.x,it.y,true,true));
  updateHUD(); setLog('Заново');
}

function bossPatrol(dt){
  const b=S.boss, [L,R]=S.bpath;
  b.x += (S.bdir)*90*(dt/1000);
  if(b.x<L){b.x=L;S.bdir=1;} if(b.x>R){b.x=R;S.bdir=-1;}
  b.setFlipX(S.bdir<0?false:true);
  const g=S.vision; g.clear();
  const dir=S.bdir>0?1:-1, x=b.x, y=b.y-18;
  g.fillStyle(0xff7878,0.22);
  g.beginPath(); g.moveTo(x,y);
  g.quadraticBezierTo(x+dir*180, y-50, x+dir*240, y+20);
  g.quadraticBezierTo(x+dir*180, y+90, x, y);
  g.closePath(); g.fillPath();
  if(S.pRoom===2 && !S.pHidden){
    const px=S.player.x, py=S.player.y-16;
    const dx=px-x, dy=py-y; const dd=Math.hypot(dx,dy);
    const facing = dir>0?0:Math.PI;
    const ang=Math.atan2(dy,dx); let diff=Math.abs(norm(ang-facing));
    if(dd<220 && diff<Math.PI/4){
      S.bsee = (S.bsee||0) + dt; if(S.bsee>600){ caught(); S.bsee=0; }
    } else S.bsee=Math.max(0,(S.bsee||0)-dt*2);
  }
}
function norm(a){while(a>Math.PI) a-=Math.PI*2; while(a<-Math.PI) a+=Math.PI*2; return a;}
function caught(){
  S.catches=(S.catches||0)+1; UI.caught.textContent=S.catches;
  S.player.setPosition(100,620); S.pRoom=0; S.pHidden=false; setLog('Z тебя заметил! Возвращаю в начало.');
}

function startGame(){ started=true; paused=false; finished=false; S.time=0; S.inv=[]; setLog('Начали. Подбирай предметы и пакости!'); }
</script>
</body>
</html>
